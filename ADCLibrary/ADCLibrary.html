<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ADC C Library - Advanced Computer Engineering</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item "><a href="../Introduction/Introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">Debian Rock C4</li><li class="chapter-item "><a href="../Debian_Rock/Debian_Rock.html"><strong aria-hidden="true">2.</strong> Debian Rock C4</a></li><li class="chapter-item "><a href="../tmux/tmux.html"><strong aria-hidden="true">3.</strong> Terminal Multiplexing</a></li><li class="chapter-item "><a href="../vim/vim.html"><strong aria-hidden="true">4.</strong> vim</a></li><li class="chapter-item "><div><strong aria-hidden="true">5.</strong> Fork Bomb</div></li><li class="chapter-item "><div><strong aria-hidden="true">6.</strong> Multi-Threading 1</div></li><li class="chapter-item "><div><strong aria-hidden="true">7.</strong> Multi-Threading 2</div></li><li class="chapter-item "><div><strong aria-hidden="true">8.</strong> System Calls</div></li><li class="chapter-item "><div><strong aria-hidden="true">9.</strong> Daemons</div></li><li class="chapter-item "><div><strong aria-hidden="true">10.</strong> UUID</div></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">BeagleBoard</li><li class="chapter-item "><a href="../ChipExploration/ChipExploration.html"><strong aria-hidden="true">11.</strong> Exploring the Chips</a></li><li class="chapter-item "><a href="../PinExploration/PinExploration.html"><strong aria-hidden="true">12.</strong> PinExploration</a></li><li class="chapter-item "><a href="../GPIOLibrary/GPIOLibrary.html"><strong aria-hidden="true">13.</strong> GPIO C Library</a></li><li class="chapter-item expanded "><a href="../ADCLibrary/ADCLibrary.html" class="active"><strong aria-hidden="true">14.</strong> ADC C Library</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../ADCLibrary/ADCContinous.html"><strong aria-hidden="true">14.1.</strong> ADC Continous </a></li></ol></li><li class="chapter-item "><a href="../PWMLibrary/PWMLibrary.html"><strong aria-hidden="true">15.</strong> PWM C Library</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../PWMLibrary/ADCtoPWM.html"><strong aria-hidden="true">15.1.</strong> ADC to PWM Library</a></li></ol></li><li class="chapter-item "><a href="../Libioctrl/Libioctrl.html"><strong aria-hidden="true">16.</strong> libioctrl</a></li><li class="chapter-item "><div><strong aria-hidden="true">17.</strong> USB Ethernet</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div><strong aria-hidden="true">17.1.</strong> USB to Ethernet sniffing tool</div></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">18.</strong> Mounting an SD</div></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">C</li><li class="chapter-item "><div><strong aria-hidden="true">19.</strong> Learning C</div></li><li class="chapter-item "><div><strong aria-hidden="true">20.</strong> Embedded C</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div><strong aria-hidden="true">20.1.</strong> atmega328p</div></li><li class="chapter-item "><div><strong aria-hidden="true">20.2.</strong> avr-gcc</div></li><li class="chapter-item "><div><strong aria-hidden="true">20.3.</strong> Blink</div></li><li class="chapter-item "><div><strong aria-hidden="true">20.4.</strong> UART</div></li></ol></li><li class="chapter-item "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">Rust</li><li class="chapter-item "><div><strong aria-hidden="true">21.</strong> Intro to Rust</div></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">Bourne Again SHell</li><li class="chapter-item "><a href="../Redirection/Redirection.html"><strong aria-hidden="true">22.</strong> Redirection</a></li><li class="chapter-item "><a href="../Bash/Bash_Scripting.html"><strong aria-hidden="true">23.</strong> Bash</a></li><li class="chapter-item "><a href="../ManPages/ManPages.html"><strong aria-hidden="true">24.</strong> Man Pages</a></li><li class="chapter-item "><a href="../SystemsStats/SystemsStats.html"><strong aria-hidden="true">25.</strong> Systems Stats Script</a></li><li class="chapter-item "><a href="../RFC_Logger/rfclogger.html"><strong aria-hidden="true">26.</strong> RFC Logger</a></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">Git</li><li class="chapter-item "><a href="../myFirstRepository/myFirstRepository.html"><strong aria-hidden="true">27.</strong> My First Repository</a></li><li class="chapter-item "><a href="../BranchingModel/BranchingModel.html"><strong aria-hidden="true">28.</strong> Branching-Strategy</a></li><li class="chapter-item "><a href="../OneFlow/OneFlow.html"><strong aria-hidden="true">29.</strong> Git Oneflow</a></li><li class="chapter-item "><a href="../AntiPatterns/AntiPatterns.html"><strong aria-hidden="true">30.</strong> Anti Patterns</a></li><li class="chapter-item "><a href="../ContinousDeployment/ContinousDeployment.html"><strong aria-hidden="true">31.</strong> Continous Deployment</a></li><li class="chapter-item "><a href="../ReleaseDeployment/ReleaseDeployment.html"><strong aria-hidden="true">32.</strong> Release Deployment</a></li><li class="chapter-item "><a href="../Migration/Migration.html"><strong aria-hidden="true">33.</strong> Migration</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Advanced Computer Engineering</h1>

                    <div class="right-buttons">

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="adc-library-creation-and-system-wide-installation-guide"><a class="header" href="#adc-library-creation-and-system-wide-installation-guide">ADC Library Creation and System-Wide Installation Guide</a></h1>
<p>This guide will detail how to set up the BeagleBone Black (BBB) to use its Analog-to-Digital Converter (ADC) capabilities. ADCs are crucial for interfacing with analog sensors, such as temperature sensors, potentiometers, and light sensors, converting analog signals into digital data that the BBB can process. The BBB provides several onboard ADCs that allow reading analog values directly through the Linux filesystem. This walkthrough will guide you through the steps needed to create a reusable ADC library in C, compile it into both static and shared libraries, and install it system-wide on the BBB.</p>
<h2 id="1-linux-kernel-version"><a class="header" href="#1-linux-kernel-version">1. Linux Kernel Version</a></h2>
<p>This guide assumes that your BBB is running Linux Kernel 4.1.15 or later. If you're using an earlier version, such as 3.8.x, there may be differences in how GPIOs and ADCs are handled, and additional steps might be necessary.</p>
<h2 id="2-introduction-to-beaglebone-blacks-adc-capabilities"><a class="header" href="#2-introduction-to-beaglebone-blacks-adc-capabilities">2. Introduction to BeagleBone Black's ADC Capabilities</a></h2>
<p>The BeagleBone Black (BBB) has a built-in ADC subsystem that can read analog signals on specific pins. The ADC subsystem can read voltages between 0 and 1.8V and convert them into a digital value. On the BBB, ADC values are accessed through the sysfs interface at <code>/sys/bus/iio/devices/iio:device0</code>.</p>
<h3 id="21-adc-numbering-scheme"><a class="header" href="#21-adc-numbering-scheme">2.1 ADC Numbering Scheme</a></h3>
<p>Each ADC channel on the BBB is identified by a number. For example, <code>in_voltage0_raw</code> corresponds to ADC channel 0, <code>in_voltage1_raw</code> to channel 1, and so on. The raw files provide the raw digital conversion value, which can be scaled as needed based on the application.</p>
<h3 id="22-why-create-a-library-for-adc"><a class="header" href="#22-why-create-a-library-for-adc">2.2 Why Create a Library for ADC?</a></h3>
<p>Creating a library for ADC operations offers several advantages:</p>
<ol>
<li>
<p><strong>Simplification</strong>: Abstracts the complex file handling operations, making the code more readable and easier to maintain.</p>
</li>
<li>
<p><strong>Reusability</strong>: The library can be reused across multiple projects without duplicating code.</p>
</li>
<li>
<p><strong>Consistency</strong>: Ensures consistent handling of ADC operations and error management across different parts of an application or different projects.</p>
</li>
<li>
<p><strong>System-Wide Access</strong>: By installing the library system-wide, any user or application can easily access the ADC functionality without duplicating setup steps.</p>
</li>
</ol>
<h2 id="3-interacting-with-adc-on-beaglebone-black-via-sysfs"><a class="header" href="#3-interacting-with-adc-on-beaglebone-black-via-sysfs">3. Interacting with ADC on BeagleBone Black via Sysfs</a></h2>
<p>To read ADC values on the BBB, you interact with files in the <code>/sys/bus/iio/devices/iio:device0</code> directory. Here’s how to perform common ADC operations using the sysfs interface:</p>
<h3 id="31-what-is-the-adc-chip"><a class="header" href="#31-what-is-the-adc-chip">3.1 What is the ADC chip?</a></h3>
<pre><code class="language-sh">$  cat /sys/bus/iio/devices/iio\:device0/name
TI-am336x-adc
</code></pre>
<p>You can review the documentation here: <a href="https://www.ti.com/lit/an/sprabu5/sprabu5.pdf">https://www.ti.com/lit/an/sprabu5/sprabu5.pdf</a></p>
<p>Source code for the driver can be found here: <a href="https://github.com/torvalds/linux/blob/master/drivers/iio/adc/ti_am335x_adc.c">https://github.com/torvalds/linux/blob/master/drivers/iio/adc/ti_am335x_adc.c</a></p>
<p>The BeagleBone Black (BBB) includes an Analog-to-Digital Converter (ADC) subsystem, which allows the board to interface with various analog sensors. This subsystem converts analog voltage signals into digital values that the processor can use.</p>
<h3 id="32-key-characteristics-of-the-beaglebone-black-adc"><a class="header" href="#32-key-characteristics-of-the-beaglebone-black-adc">3.2 Key Characteristics of the BeagleBone Black ADC</a></h3>
<ol>
<li>
<p><strong>Resolution</strong>: The BBB’s ADC is 12-bit, meaning it can represent an analog input voltage as a digital value between 0 and 4095 \((2^{12} - 1)\).</p>
</li>
<li>
<p><strong>Voltage Range</strong>: The ADC on the BBB can read voltages from 0V up to 1.8V. <strong>It is crucial to note that applying a voltage higher than 1.8V directly to an ADC pin can damage the board.</strong> Voltage dividers or other protective circuits should be used if you're measuring voltages higher than 1.8V.</p>
</li>
<li>
<p><strong>Number of Channels</strong>: The BBB has 7 usable ADC channels, labeled from <code>in_voltage0_raw</code> to <code>in_voltage6_raw</code>. These channels correspond to specific analog input pins on the P9 header.</p>
</li>
<li>
<p><strong>Sampling Rate</strong>: The BBB’s ADC can sample up to about 200k samples per second, depending on the configuration and system load. This is sufficient for many applications like reading sensor data, but may not be suitable for very high-frequency signals.</p>
</li>
</ol>
<h2 id="4-how-adc-works-on-the-beaglebone-black"><a class="header" href="#4-how-adc-works-on-the-beaglebone-black">4. How ADC Works on the BeagleBone Black</a></h2>
<p>Analog-to-Digital Converters (ADCs) work by sampling an analog voltage signal and converting it to a digital number that represents the magnitude of the analog signal. This digital representation is what the processor works with. Here’s how it works in practice on the BBB:</p>
<ol>
<li>
<p><strong>Analog Voltage Input</strong>: The ADC reads an analog input voltage on one of its channels.</p>
</li>
<li>
<p><strong>Digital Representation</strong>: The ADC converts this voltage to a digital value between 0 and 4095. A value of 0 corresponds to 0V, and a value of 4095 corresponds to 1.8V.</p>
</li>
<li>
<p><strong>Voltage-to-Digital Conversion Formula</strong>: The conversion from raw ADC reading to voltage can be calculated using the formula:</p>
<p>\[
\text{Voltage (V)} = \frac{\text{ADC Reading}}{4095} \times 1.8
\]</p>
<ul>
<li><strong>ADC Reading</strong>: The raw value read from the <code>in_voltageX_raw</code> file.</li>
<li><strong>1.8</strong>: The reference voltage (1.8V), which is the maximum input voltage that the ADC can read without damage.</li>
</ul>
</li>
<li>
<p><strong>Read the Raw ADC Value</strong>:</p>
<p>Let's assume we want to read from <code>ADC Channel 0</code>. First, navigate to the appropriate directory and read the value:</p>
<pre><code class="language-bash">$ cd /sys/bus/iio/devices/iio:device0
$ cat in_voltage0_raw
</code></pre>
<p>Suppose the command returns a value of <code>2048</code>.</p>
</li>
<li>
<p><strong>Convert the Raw Value to a Voltage</strong>:</p>
<p>Use the formula mentioned earlier to convert the raw ADC value to a voltage:</p>
<p>\[
\text{Voltage (V)} = \frac{2048}{4095} \times 1.8 = 0.9 , \text{V}
\]</p>
<p>This means the analog signal at <code>ADC Channel 0</code> corresponds to a voltage of approximately 0.9V.</p>
</li>
</ol>
<h3 id="5-list-available-adc-channels"><a class="header" href="#5-list-available-adc-channels">5. List Available ADC Channels</a></h3>
<p>The BeagleBone Black (BBB) allows you to interact with its Analog-to-Digital Converter (ADC) through the sysfs interface, located at <code>/sys/bus/iio/devices/iio:device0</code>. This directory contains various files and subdirectories that provide access to the ADC hardware and its configuration. Below is an explanation of each file and subdirectory you might see when you run ls in this directory:</p>
<pre><code class="language-bash">$ cd /sys/bus/iio/devices/iio:device0
$ ls -l
buffer  in_voltage0_raw  in_voltage2_raw  in_voltage4_raw  in_voltage6_raw  name     power          subsystem
dev     in_voltage1_raw  in_voltage3_raw  in_voltage5_raw  in_voltage7_raw  of_node  scan_elements  uevent
</code></pre>
<p><strong>Explanation of Files and Directories</strong>:</p>
<ol>
<li>
<p><code>buffer</code></p>
<ul>
<li>
<p><strong>Purpose</strong>: This directory contains files related to buffer management for the ADC.</p>
</li>
<li>
<p><strong>Usage</strong>: Buffering is typically used in applications requiring continuous data sampling (like high-frequency sensor data collection). Configuring the buffer allows you to read multiple samples at once, which is more efficient than reading single samples one at a time.</p>
</li>
<li>
<p><strong>Details</strong>: This directory is often used in advanced applications where high-speed data acquisition is needed.</p>
</li>
</ul>
</li>
<li>
<p><code>in_voltageX_raw</code> (e.g., <code>in_voltage0_raw</code>, <code>in_voltage1_raw</code>, ... <code>in_voltage7_raw</code>)</p>
<ul>
<li>
<p><strong>Purpose</strong>: These files represent the raw ADC values read from the corresponding ADC channels (0 through 7).</p>
</li>
<li>
<p><strong>Values</strong>: Reading from these files returns an integer representing the digital conversion of the analog signal present on the corresponding ADC pin.</p>
</li>
<li>
<p><strong>Usage</strong>: You can use the cat command to read the raw ADC value from a specific channel:</p>
<pre><code class="language-bash">$ cat in_voltage0_raw
</code></pre>
</li>
<li>
<p><strong>Details</strong>: The raw value is typically between 0 and 4095 for a 12-bit ADC, representing the analog voltage scaled between 0V and the reference voltage (1.8V on the BBB).</p>
</li>
</ul>
</li>
<li>
<p><code>name</code></p>
<ul>
<li>
<p><strong>Purpose</strong>: This file provides the name of the ADC device.</p>
</li>
<li>
<p><strong>Usage</strong>: Reading this file returns a string that typically identifies the ADC controller's driver name, which might look something like <code>TI-am335x-adc</code>.</p>
</li>
<li>
<p><strong>Details</strong>: Knowing the driver name can help in debugging or configuring specific driver-related parameters.</p>
</li>
</ul>
</li>
<li>
<p><code>dev</code></p>
<ul>
<li>
<p><strong>Purpose</strong>: This file represents the device number assigned to the ADC by the Linux kernel.</p>
</li>
<li>
<p><strong>Details</strong>: This is typically used internally by the kernel and device management systems to handle device nodes and their associations.</p>
</li>
</ul>
</li>
<li>
<p><code>of_node</code></p>
<ul>
<li>
<p><strong>Purpose</strong>: This directory represents the device tree node associated with the ADC hardware.</p>
</li>
<li>
<p><strong>Details</strong>: The device tree is a data structure that describes the hardware components of the system to the operating system. The of_node directory can contain properties that reflect how the hardware is described in the device tree source.</p>
</li>
<li>
<p><strong>Usage</strong>: Typically used for debugging or understanding hardware configuration, not usually modified by end-users.</p>
</li>
</ul>
</li>
<li>
<p><code>power</code></p>
<ul>
<li>
<p><strong>Purpose</strong>: This directory contains power management files for the ADC device.</p>
</li>
<li>
<p><strong>Usage</strong>: You can use the files within this directory to manage the power state of the ADC. For example, some systems might allow you to enable or disable the ADC to save power when it's not in use.</p>
</li>
<li>
<p><strong>Details</strong>: This is often used in power-constrained environments where the ADC might be turned off to save energy.</p>
</li>
</ul>
</li>
<li>
<p><code>scan_elements</code></p>
<ul>
<li>
<p><strong>Purpose</strong>: This directory contains files related to configuring scan elements for buffered readings.</p>
</li>
<li>
<p><strong>Usage</strong>: In applications where multiple channels are read in a scan sequence (multi-channel ADC reads), this directory is used to configure which channels are included in the scan and in what order.</p>
</li>
<li>
<p><strong>Details</strong>: This is advanced functionality typically used in applications requiring synchronized sampling of multiple inputs.</p>
</li>
</ul>
</li>
<li>
<p><code>subsystem</code></p>
<ul>
<li>
<p><strong>Purpose</strong>: This is a symbolic link pointing back to the subsystem the device belongs to, in this case, the IIO (Industrial I/O) subsystem.</p>
</li>
<li>
<p><strong>Details</strong>: This link provides context within the broader sysfs tree, showing how devices are organized under different subsystems (like GPIO, IIO, etc.).</p>
</li>
<li>
<p><strong>Usage</strong>: Generally used by system software for managing device trees and hierarchies.</p>
</li>
</ul>
</li>
<li>
<p><code>uevent</code></p>
<ul>
<li>
<p><strong>Purpose</strong>: This file is used by udev, the device manager for the Linux kernel, to manage dynamic device nodes.</p>
</li>
<li>
<p><strong>Usage</strong>: When read, this file provides environment variables for udev events, allowing you to see or modify the device's event handling configuration.</p>
</li>
<li>
<p><strong>Details</strong>: This is typically managed automatically and not frequently modified by users.</p>
</li>
</ul>
</li>
</ol>
<h3 id="6-making-a-adc-c-library"><a class="header" href="#6-making-a-adc-c-library">6. Making a ADC C Library</a></h3>
<ol>
<li>
<p>Create a new directory called adc in home with the following files:</p>
<pre><code class="language-sh">$ mkdir adc &amp;&amp; cd &amp;&amp; touch adc.c &amp;&amp; touch adc.h &amp;&amp; touch MakeFile
</code></pre>
</li>
<li>
<p>Edit the <code>adc.h</code> file:</p>
 <details>
 <summary>Suppressed Code here [24 lines]...</summary>
<pre><code class="language-h">#ifndef ADC_H_
#define ADC_H_

#define SYSFS_ADC_DIR "/sys/bus/iio/devices/iio:device0"

#define POLL_TIMEOUT (3 * 1000) /*3 seconds*/

#define MAX_BUF 256
#define ADC_BUF 6

int adc_get_value(unsigned int adcPin, unsigned int *value);
int adc_fd_open(unsigned int gpio);
int adc_fd_close(unsigned int fd);
int adc_en(unsigned int adcPin, unsigned int en);

#endif /* ADC_H_*/
</code></pre>
 </details>
</li>
<li>
<p>Now we can modify the <code>adc.c</code> file:</p>
 <details>
 <summary>Suppressed Code here [60 lines]...</summary>
<pre><code class="language-c">#include "adc.h"
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;errno.h&gt;
#include &lt;unistd.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;poll.h&gt;

/****************************************************************
* adc_get_value
****************************************************************/
int adc_get_value(unsigned int adcPin, unsigned int *value){
    int fd;
    char buf[MAX_BUF];
    char retChars[ADC_BUF];

    snprintf(buf, sizeof(buf), SYSFS_ADC_DIR "/in_voltage%d_raw", adcPin);

    fd = open(buf, O_RDONLY);
    if (fd &lt; 0) {
        perror("adc/get-value");
        return fd;
    }

    read(fd, retChars, 6);

    *value = strtol(retChars,NULL,0);

    close(fd);
    return 0;
}

/****************************************************************
* adc_fd_open
****************************************************************/

int adc_fd_open(unsigned int adcPin){
    int fd;
    char buf[MAX_BUF];

    snprintf(buf, sizeof(buf), SYSFS_ADC_DIR "/in_voltage%d_raw", adcPin);

    fd = open(buf, O_RDONLY | O_NONBLOCK );
    if (fd &lt; 0) {
        perror("adc/fd_open");
    }
    return fd;
}

/****************************************************************
* adc_fd_close
****************************************************************/

int adc_fd_close(unsigned int fd){
    return close(fd);
}
</code></pre>
 </details>
</li>
<li>
<p>Much like the GPIO library we can build libraries manually, compile <code>adc.c</code> into an Object File by Using the following command to compile <code>adc.c</code> into an object file (<code>adc.o</code>):</p>
<pre><code class="language-sh">$ gcc -c adc.c -o adc.o
</code></pre>
</li>
<li>
<p>Create a Static Library (<code>libadc.a</code>) to create a static library, use the <code>ar</code> command:</p>
<pre><code class="language-sh">$ ar rcs libadc.a adc.o
</code></pre>
<ul>
<li><strong>Command Breakdown:</strong>
<ul>
<li><code>ar</code>: The archiver tool used to create and maintain library archives.</li>
<li><code>rcs</code>: Flags where r inserts the files into the archive, c creates the archive if it doesn't exist, and s creates an index for quick symbol lookup.</li>
<li><code>libadc.a</code>: The name of the static library being created.</li>
<li><code>adc.o</code>: The object file to be included in the library.</li>
</ul>
</li>
</ul>
<blockquote>
<blockquote>
<p><strong>Explanation: What is a Static Library?</strong></p>
<p>A static library is a collection of object files that are linked into the final executable at compile time. Once linked, the code from the static library becomes part of the executable binary. This means that the executable will carry a copy of the library's code, making it self-contained and independent of the library file after compilation.</p>
</blockquote>
</blockquote>
</li>
<li>
<p>Create a Shared Library (<code>libadc.so</code>) to create a shared library, use the following <code>gcc</code> command:</p>
<pre><code class="language-sh">$ gcc -shared -o libadc.so adc.o
</code></pre>
<ul>
<li><strong>Command Breakdown:</strong>
<ul>
<li><code>-shared</code>: Tells gcc to produce a shared library.</li>
<li><code>-o libadc.so</code>: Specifies the output filename for the shared library.</li>
<li><code>adc.o</code>: The object file to be included in the library.</li>
</ul>
</li>
</ul>
<blockquote>
<blockquote>
<p><strong>Explanation: What is a Shared Library?</strong></p>
<p>A shared library, on the other hand, is not linked into the final executable at compile time. Instead, it is loaded into memory at runtime. Multiple programs can share a single copy of a shared library, which can save memory and allow updates to the library without recompiling the programs that use it.</p>
</blockquote>
</blockquote>
</li>
<li>
<p>Install the Header and Library Files System-Wide. You could manually copy the header file to <code>/usr/include</code> and the libraries to <code>/usr/lib</code>, or skip to the next section and create a <code>Makefile</code> to do it for you each time.</p>
<pre><code class="language-sh">$ sudo cp adc.h /usr/include/
$ sudo cp libadc.a /usr/lib/
$ sudo cp libadc.so /usr/lib/
$ sudo ldconfig  # Update the shared library cache
</code></pre>
</li>
<li>
<p>We can do this using a Makefile aswell, edit the <code>Makefile</code>:</p>
 <details>
 <summary>Suppressed code here [43 lines]...</summary>
<pre><code class="language-makefile"># Variables
CC = gcc
CFLAGS = -Wall -Werror -fPIC  # -fPIC is needed for shared libraries
AR = ar
ARFLAGS = rcs
TARGET_STATIC = libadc.a
TARGET_SHARED = libadc.so
OBJ = adc.o

# Default target: Build both libraries
all: $(TARGET_STATIC) $(TARGET_SHARED)

# Compile the adc.c into an object file
$(OBJ): adc.c
        $(CC) $(CFLAGS) -c adc.c -o $(OBJ)

# Create the static library
$(TARGET_STATIC): $(OBJ)
        $(AR) $(ARFLAGS) $(TARGET_STATIC) $(OBJ)

# Create the shared library
$(TARGET_SHARED): $(OBJ)
        $(CC) -shared -o $(TARGET_SHARED) $(OBJ)

# Clean up build artifacts
clean:
        rm -f $(OBJ) $(TARGET_STATIC) $(TARGET_SHARED)

# Install libraries and header
install: $(TARGET_STATIC) $(TARGET_SHARED)
        sudo cp adc.h /usr/include/
        sudo cp $(TARGET_STATIC) /usr/lib/
        sudo cp $(TARGET_SHARED) /usr/lib/
        sudo ldconfig

# Uninstall libraries and header
uninstall:
        sudo rm -f /usr/include/adc.h
        sudo rm -f /usr/lib/$(TARGET_STATIC)
        sudo rm -f /usr/lib/$(TARGET_SHARED)
        sudo ldconfig

# Phony targets
.PHONY: all clean install uninstall
</code></pre>
</li>
<li>
<p>As long as the Makefile is within directory with the custom adc c files you can use the <code>make</code> command:</p>
<ul>
<li>
<p>Remove <code>adc.h</code>, and static and share libraries from the respective directories</p>
<pre><code class="language-sh">$ make uninstall
</code></pre>
</li>
<li>
<p>To clean up the build artefacts run:</p>
<pre><code class="language-sh">$ make clean
</code></pre>
</li>
<li>
<p>To build the libraries and object files:</p>
<pre><code class="language-sh">$ make all
</code></pre>
</li>
<li>
<p>Lastly, use the install command to <code>cp</code> libraries and header to respective root directories:</p>
<pre><code class="language-sh">$ make install
&gt; gcc -Wall -Werror -fPIC   -c adc.c -o adc.o
  ar rcs libadc.a adc.o
  gcc -shared -o libadco.so adc.o
</code></pre>
</li>
</ul>
</li>
</ol>
<h2 id="7-using-the-our-new-libary-to-control-a-pin"><a class="header" href="#7-using-the-our-new-libary-to-control-a-pin">7: Using the our new libary to control a pin</a></h2>
<ol start="9">
<li>
<p>Change directory and <code>../</code> and make a new directory called <code>adc_read</code> and navigate into it.</p>
<pre><code class="language-sh">$ cd ../
$ mkdir adc_read
$ cd adc_read
</code></pre>
</li>
<li>
<p>Create a new .c file called... <code>adc_read.c</code> and chose your preferred editor to open it.</p>
<pre><code class="language-sh">$ touch adc_read.c
$ vim adc_read.c
</code></pre>
</li>
<li>
<p>Now we are going to set up the program to use our system wide library and header with <code>adc.h</code>:</p>
<details>
<summary>Suppressed code here [17 lines]...</summary>
<pre><code class="language-c">#include "adc.h"
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

int main(){
    unsigned int i = 0;
    unsigned int adc_reading = 0;
    while(i &lt; 30){

        adc_get_value(0, &amp;adc_reading);

        printf("ADC: %u\n ",adc_reading);
        sleep(1);

    }
    return 0;
}
</code></pre>
</details>
</li>
<li>
<p>We can use this oneliner to compile the code:</p>
<pre><code class="language-sh">$ gcc adc_read.c -ladc -o adc_read
</code></pre>
</li>
<li>
<p>Alternatively we can use a <code>Makefile</code> like before:</p>
<pre><code class="language-makefile"># Compiler and flags
CC = gcc
CFLAGS = -Wall -Werror

# Target executable name
TARGET = adc_read

# Source files
SRC = adc_read.c

# Library to link against
LIBS = -ladc

# Default target: build the executable
all: $(TARGET)

# Build the executable
$(TARGET): $(SRC)
        $(CC) $(CFLAGS) $(SRC) $(LIBS) -o $(TARGET)

# Clean up build artifacts
clean:
        rm -f $(TARGET)

# Phony targets to avoid conflicts with files of the same name
.PHONY: all clean
</code></pre>
<p>Invoke make to build the executable:</p>
<pre><code class="language-sh">$ make
</code></pre>
</li>
<li>
<p>Use the led and etc to wire up and run the code:</p>
<pre><code class="language-sh">$ ./adc_read
</code></pre>
<ul>
<li>
<p>If all is well, and you have connected up your potentiometer to the correct pin, and you rotate it you should see the following output:</p>
<pre><code>ADC: 4019
ADC: 4018
ADC: 4018
ADC: 3634
ADC: 2991
ADC: 2713
ADC: 2442
ADC: 2256
ADC: 2028
ADC: 1833
ADC: 1604
ADC: 1334
ADC: 1149
ADC: 1199
ADC: 1095
ADC: 681
ADC: 410
... # upto 30 times
</code></pre>
</li>
</ul>
</li>
<li>
<p>Extra: Continuous Sampling with Buffering</p>
<p>Consider making use of the buffer in <code>/sys/bus/iio/devices/iio\:device0/buffer/</code> which has the following:</p>
<pre><code>data_available  enable          length          watermark
</code></pre>
<ul>
<li>
<p><strong>Functionality</strong>: Enable continuous sampling mode using buffers and interrupts.</p>
</li>
<li>
<p><strong>Purpose</strong>: For applications requiring high-speed sampling or real-time data monitoring, like audio signal processing or monitoring fast-changing sensors.</p>
</li>
<li>
<p><strong>How to Implement</strong>:</p>
<ul>
<li>Set up a circular buffer in the kernel space to store ADC samples.</li>
<li>Use interrupts or polling to read data from the buffer when new samples are available.</li>
<li>Implement callback functions to handle the buffered data.</li>
</ul>
</li>
</ul>
<p><strong>Example Prototypes:</strong></p>
<pre><code class="language-h">int adc_start_continuous_sampling(unsigned int channel, size_t buffer_size);
void adc_stop_continuous_sampling(void);
void adc_register_callback(void (*callback)(unsigned int value));
</code></pre>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../GPIOLibrary/GPIOLibrary.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../ADCLibrary/ADCContinous.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../GPIOLibrary/GPIOLibrary.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../ADCLibrary/ADCContinous.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
