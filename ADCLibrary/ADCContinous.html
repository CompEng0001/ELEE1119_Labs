<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ADC Continous  - Advanced Computer Engineering</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item "><a href="../Introduction/Introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">Debian Rock C4</li><li class="chapter-item "><a href="../Debian_Rock/Debian_Rock.html"><strong aria-hidden="true">2.</strong> Debian Rock C4</a></li><li class="chapter-item "><a href="../tmux/tmux.html"><strong aria-hidden="true">3.</strong> Terminal Multiplexing</a></li><li class="chapter-item "><a href="../vim/vim.html"><strong aria-hidden="true">4.</strong> vim</a></li><li class="chapter-item "><div><strong aria-hidden="true">5.</strong> Fork Bomb</div></li><li class="chapter-item "><div><strong aria-hidden="true">6.</strong> Multi-Threading 1</div></li><li class="chapter-item "><div><strong aria-hidden="true">7.</strong> Multi-Threading 2</div></li><li class="chapter-item "><div><strong aria-hidden="true">8.</strong> System Calls</div></li><li class="chapter-item "><div><strong aria-hidden="true">9.</strong> Daemons</div></li><li class="chapter-item "><div><strong aria-hidden="true">10.</strong> UUID</div></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">BeagleBoard</li><li class="chapter-item "><a href="../ChipExploration/ChipExploration.html"><strong aria-hidden="true">11.</strong> Exploring the Chips</a></li><li class="chapter-item "><a href="../PinExploration/PinExploration.html"><strong aria-hidden="true">12.</strong> PinExploration</a></li><li class="chapter-item "><a href="../GPIOLibrary/GPIOLibrary.html"><strong aria-hidden="true">13.</strong> GPIO C Library</a></li><li class="chapter-item expanded "><a href="../ADCLibrary/ADCLibrary.html"><strong aria-hidden="true">14.</strong> ADC C Library</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ADCLibrary/ADCContinous.html" class="active"><strong aria-hidden="true">14.1.</strong> ADC Continous </a></li></ol></li><li class="chapter-item "><a href="../PWMLibrary/PWMLibrary.html"><strong aria-hidden="true">15.</strong> PWM C Library</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../PWMLibrary/ADCtoPWM.html"><strong aria-hidden="true">15.1.</strong> ADC to PWM Library</a></li></ol></li><li class="chapter-item "><a href="../Libioctrl/Libioctrl.html"><strong aria-hidden="true">16.</strong> libioctrl</a></li><li class="chapter-item "><div><strong aria-hidden="true">17.</strong> USB Ethernet</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><div><strong aria-hidden="true">17.1.</strong> USB to Ethernet sniffing tool</div></li></ol></li><li class="chapter-item "><div><strong aria-hidden="true">18.</strong> Mounting an SD</div></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">C</li><li class="chapter-item "><a href="../Learning_C/Learning_C.html"><strong aria-hidden="true">19.</strong> Learning C</a></li><li class="chapter-item "><a href="../EmbeddedC/Embedded.html"><strong aria-hidden="true">20.</strong> Embedded C</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../EmbeddedC/atmega328p.html"><strong aria-hidden="true">20.1.</strong> atmega328p</a></li><li class="chapter-item "><a href="../EmbeddedC/avg_gcc.html"><strong aria-hidden="true">20.2.</strong> avr-gcc</a></li><li class="chapter-item "><a href="../EmbeddedC/blink.html"><strong aria-hidden="true">20.3.</strong> Blink</a></li><li class="chapter-item "><div><strong aria-hidden="true">20.4.</strong> UART</div></li><li class="chapter-item "><div><strong aria-hidden="true">20.5.</strong> ADC</div></li></ol></li><li class="chapter-item "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">Rust</li><li class="chapter-item "><div><strong aria-hidden="true">21.</strong> Intro to Rust</div></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">Bourne Again SHell</li><li class="chapter-item "><a href="../Redirection/Redirection.html"><strong aria-hidden="true">22.</strong> Redirection</a></li><li class="chapter-item "><a href="../Bash/Bash_Scripting.html"><strong aria-hidden="true">23.</strong> Bash</a></li><li class="chapter-item "><a href="../ManPages/ManPages.html"><strong aria-hidden="true">24.</strong> Man Pages</a></li><li class="chapter-item "><a href="../SystemsStats/SystemsStats.html"><strong aria-hidden="true">25.</strong> Systems Stats Script</a></li><li class="chapter-item "><a href="../RFC_Logger/rfclogger.html"><strong aria-hidden="true">26.</strong> RFC Logger</a></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="spacer"></li><li class="chapter-item affix "><li class="part-title">Git</li><li class="chapter-item "><a href="../myFirstRepository/myFirstRepository.html"><strong aria-hidden="true">27.</strong> My First Repository</a></li><li class="chapter-item "><a href="../BranchingModel/BranchingModel.html"><strong aria-hidden="true">28.</strong> Branching-Strategy</a></li><li class="chapter-item "><a href="../OneFlow/OneFlow.html"><strong aria-hidden="true">29.</strong> Git Oneflow</a></li><li class="chapter-item "><a href="../AntiPatterns/AntiPatterns.html"><strong aria-hidden="true">30.</strong> Anti Patterns</a></li><li class="chapter-item "><a href="../ContinousDeployment/ContinousDeployment.html"><strong aria-hidden="true">31.</strong> Continous Deployment</a></li><li class="chapter-item "><a href="../ReleaseDeployment/ReleaseDeployment.html"><strong aria-hidden="true">32.</strong> Release Deployment</a></li><li class="chapter-item "><a href="../Migration/Migration.html"><strong aria-hidden="true">33.</strong> Migration</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Advanced Computer Engineering</h1>

                    <div class="right-buttons">

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="adc-library---continous-measurements"><a class="header" href="#adc-library---continous-measurements">ADC Library - Continous measurements</a></h1>
<blockquote>
<p><strong>Note:</strong></p>
<blockquote>
<ul>
<li>You need to have finished <a href="./ADCLibrary.html">ADCLibrary section</a></li>
</ul>
</blockquote>
</blockquote>
<h2 id="1-important-information"><a class="header" href="#1-important-information">1. Important information</a></h2>
<p>So far we are reading analog voltages in one-shot mode. Most applications need continuous reading of input values. For continuous mode, we need a buffer to capture the input values while the BBB is doing something else.</p>
<p>Important folders in the iio:deviceX directory are:</p>
<ul>
<li>
<p><code>buffer\</code></p>
<ul>
<li><code>enable</code>: get and set the state of the buffer</li>
<li><code>length</code>: get and set the length of the buffer.</li>
</ul>
</li>
<li>
<p>The buffer can be enabled by doing:</p>
<pre><code>debian@beaglebone:~# echo 1 &gt; /sys/bus/iio/devices/iio\:device0/scan_elements/in_voltage0_en
debian@beaglebone:~# echo 100 &gt; /sys/bus/iio/devices/iio\:device0/buffer/length
debian@beaglebone:~# echo 1 &gt; /sys/bus/iio/devices/iio\:device0/buffer/enable
</code></pre>
</li>
</ul>
<p>The first line tells which analog channel to scan. Just change the x in in_voltagex_en if you need a different analog channel. The second line specifies the length of the buffer and the last line enables the buffer.</p>
<ul>
<li>
<p><code>scan_elements</code> directory contains interfaces for elements that will be captured for a single sample set in the buffer.</p>
<pre><code class="language-bash">debian@beaglebone:~# ls -al /sys/bus/iio/devices/iio\:device0/scan_elements/
drwxr-xr-x    2 root     root            0 Jan  1 00:00 .
drwxr-xr-x    5 root     root            0 Jan  1 00:00 ..
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage0_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage0_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage0_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage1_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage1_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage1_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage2_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage2_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage2_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage3_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage3_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage3_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage4_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage4_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage4_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage5_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage5_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage5_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage6_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage6_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage6_type
-rw-r--r--    1 root     root         4096 Jan  1 00:02 in_voltage7_en
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage7_index
-r--r--r--    1 root     root         4096 Jan  1 00:02 in_voltage7_type
</code></pre>
</li>
<li>
<p><code>scan_elements</code> exposes 3 files per channel:</p>
<ul>
<li><code>in_voltageX_en</code>: is this channel enabled?</li>
<li><code>in_voltageX_index</code>: index of this channel in the buffer’s chunks</li>
<li><code>in_voltageX_type</code> : How the ADC stores its data. Reading this file should return you a string something like below:</li>
</ul>
<pre><code class="language-bash">debian@beaglebone:~# cat /sys/bus/iio/devices/iio\:device0/scan_elements/in_voltage1_type
le:u12/16&gt;&gt;0
</code></pre>
<ul>
<li>
<p>Where:</p>
<ul>
<li><code>le</code> represents the endianness, here little endian</li>
<li><code>u</code> is the sign of the value returned. It could be either <code>u</code> (for unsigned) or <code>s</code> (for signed)</li>
<li><code>12</code> is the number of relevant bits of information</li>
<li><code>16</code> is the actual number of bits used to store the datum</li>
<li><code>0</code> is the number of right shifts needed.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>When the ADC sequencer finishes cycling through all the enabled channels, the user can decide if the sequencer should stop (one-shot mode), or loop back and schedule again (continuous mode). If one-shot mode is enabled, then the sequencer will only be scheduled one time (the sequencer HW will automatically disable the StepEnable bit after it is scheduled which will guarantee only one sample is taken per channel). When the user wants to continuously take samples, continuous mode needs to be enabled. One cannot read ADC data from one channel operating in One-shot mode and and other in continuous mode at the same time.</p>
<h2 id="2-updating-adch"><a class="header" href="#2-updating-adch">2. Updating <code>adc.h</code></a></h2>
<p>You need to update the adc.h header file to take advantage of the continous mode offered by the ADC chip:</p>
<ul>
<li>
<p>We are adding adding the following macros:</p>
<pre><code class="language-h">#define SYSFS_ADC_ENABLE_PATH "/sys/bus/iio/devices/iio:device0/buffer/enable"
#define SYSFS_ADC_LENGTH_PATH "/sys/bus/iio/devices/iio:device0/buffer/length"
#define SYSFS_ADC_SCAN_DIR "/sys/bus/iio/devices/iio:device0/scan_elements"

... 

#define ADC_BUF 6
#define REFVOLTAGE 1.8
#define MAXADC 4096
#define MAX_SAMPLE_RATE 2000000 // 200kSPS
</code></pre>
</li>
<li>
<p>Additionally we are adding the following prototypes:</p>
<pre><code class="language-h">int adc_to_voltage(unsigned int adcValue, float *voltage);
int adc_get_buffer(unsigned int adcPin, unsigned int *value);
int enable_channel(unsigned int adcPin);
int disable_channel(unsigned int adcPin);
int enable_buffer(void);
int disable_buffer(void);
int set_buffer_length(unsigned int len);
</code></pre>
  <details>
  <summary>Full code here...</summary>
<pre><code class="language-h">#ifndef ADC_H_
#define ADC_H_

/**************************************************
* Contents                                       *
* ***********************************************/

#define SYSFS_ADC_DIR "/sys/bus/iio/devices/iio:device0"
#define SYSFS_ADC_ENABLE_PATH "/sys/bus/iio/devices/iio:device0/buffer/enable"
#define SYSFS_ADC_LENGTH_PATH "/sys/bus/iio/devices/iio:device0/buffer/length"
#define SYSFS_ADC_SCAN_DIR "/sys/bus/iio/devices/iio:device0/scan_elements"

#define POLL_TIMEOUT (3 * 1000) /*3 seconds*/

#define MAX_BUF 256
#define MAX_LEN_BUF 100
#define ADC_BUF 6
#define REFVOLTAGE 1.8
#define MAXADC 4096
#define MAX_SAMPLE_RATE 2000000 // 200kSPS

/************************************************
* ADC RELATED                                  *
************************************************/
int adc_get_value(unsigned int adcPin, unsigned int *value);
int adc_fd_open(unsigned int gpio);
int adc_fd_close(unsigned int fd);
int adc_to_voltage(unsigned int adcValue, float *voltage);
int adc_get_buffer(unsigned int adcPin, unsigned int *value);
int enable_channel(unsigned int adcPin);
int disable_channel(unsigned int adcPin);
int enable_buffer(void);
int disable_buffer(void);
int set_buffer_length(unsigned int len);

#endif /* ADC_H_*/

</code></pre>
  </details>
</li>
</ul>
<h2 id="3-updating-adcc"><a class="header" href="#3-updating-adcc">3. Updating <code>adc.c</code></a></h2>
<p>Now we need to update <code>adc.c</code> to create the functionality of our new prototypes:</p>
<ol>
<li>
<p>Starting with <code>int enable_channel(...);</code>:</p>
<p>Add to the bottom of the <code>adc.c</code> file:</p>
<pre><code class="language-c">/***************************************************************
* enable_channel
****************************************************************/

int enable_channel(unsigned int adcPin){

    int fd;
    char buf[MAX_BUF];

    snprintf(buf, sizeof(buf),SYSFS_ADC_SCAN_DIR "/in_voltage%d_en", adcPin); 

    fd = open(buf,O_WRONLY);
    if (fd &lt; 0) {
        perror("adc/scan_element/");
        return fd; 
    }

    // to enable continous mode
    write(fd, "1", 2);
    close(fd);

    return 0;

}
</code></pre>
</li>
<li>
<p>Likewise of <code>int disable_channel(...)</code>, you only need to modify the <code>write()</code>... as <code>write(fd, "0",2);</code></p>
 <details>
 <summary>Code here... </summary>
<pre><code class="language-c">/***************************************************************
* disable_channel
****************************************************************/

int disable_channel(unsigned int adcPin){

    int fd;
    char buf[MAX_BUF];

    snprintf(buf, sizeof(buf),SYSFS_ADC_SCAN_DIR "/in_voltage%d_en", adcPin); 

    fd = open(buf,O_WRONLY);
    if (fd &lt; 0) {
        perror("adc/scan_element/");
        return fd; 
    }

    // to disable continous mode
    write(fd, "0", 2);
    close(fd);

    return 0;

}
</code></pre>
 </details>
</li>
<li>
<p>Next we need to do the same for <code>enable_buffer()</code> and <code>disable_buffer()</code></p>
<ul>
<li>
<p><code>int enable_buffer(void);</code></p>
  <details>
  <summary>Code here...</summary>
<pre><code class="language-c">/***************************************************************
* enable_buffer
****************************************************************/

int enable_buffer(void){

    int fd;
    char buf[MAX_BUF];

    // to enable continous mode
    snprintf(buf, sizeof(buf),SYSFS_ADC_ENABLE_PATH); 

    fd = open(buf,O_WRONLY);
    if (fd &lt; 0) {
        perror("adc/buffer/enable");
        return fd; 
    }

    write(fd, "1", 2);
    close(fd);

    return 0;

}
</code></pre>
  </details>
</li>
<li>
<p>Likewise of <code>int disable_buffer(...)</code>, you only need to modify the <code>write()</code>... as <code>write(fd, "0",2);</code>:</p>
  <details>
  <summary>Code here...</summary>
<pre><code class="language-c">/***************************************************************
* disable_buffer
****************************************************************/

int disable_buffer(void){

    int fd;
    char buf[MAX_BUF];

    // to enable continous mode
    snprintf(buf, sizeof(buf),SYSFS_ADC_ENABLE_PATH); 

    fd = open(buf,O_WRONLY);
    if (fd &lt; 0) {
        perror("adc/buffer/enable");
        return fd; 
    }

    write(fd, "0", 2);
    close(fd);

    return 0;

}
</code></pre>
  </details>
</li>
</ul>
</li>
<li>
<p>Next we need to set the buffer length as to store <em>n</em> values:</p>
 <details>
 <summary>Code here...</summary>
<pre><code class="language-c">/***************************************************************
* set_buffer_length
****************************************************************/

int set_buffer_length(unsigned int len){

    int fd;
    char buf[MAX_BUF];
    char lenBuf[MAX_LEN_BUF];

    snprintf(buf, sizeof(buf),SYSFS_ADC_LENGTH_PATH);

    fd = open(buf,O_WRONLY);
    if (fd &lt; 0) {
        perror("adc/buffer/length");
        return fd; 
    }

    snprintf(lenBuf, sizeof(lenBuf),"%d",len);

    write(fd, lenBuf, sizeof(lenBuf));
    close(fd);

    return 0;

}
</code></pre>
 </details>
</li>
<li>
<p>Lastly, for the adc continous mode, we need to create the <code>adc_get_buffer(...)</code>:</p>
 <details>
 <summary>Code here...</summary>
<pre><code class="language-c">/****************************************************************
* adc_get_buffer
****************************************************************/
int adc_get_buffer(unsigned int adcPin, unsigned int *value) {
    int fd;
    char buf[MAX_BUF];
    char retChars[ADC_BUF];

    // Path to buffered ADC values
    snprintf(buf, sizeof(buf), SYSFS_ADC_DIR "/in_voltage%d_raw", adcPin);

    // Open the buffer file
    fd = open(buf, O_RDONLY | O_NONBLOCK);
    if (fd &lt; 0) {
        perror("adc/get-buffer");
        return fd;
    }

    // Read buffer data
    ssize_t bytesRead = read(fd, retChars, sizeof(retChars));
    if (bytesRead &lt; 0) {
        perror("adc/get-buffer/read");
        close(fd);
        return -1;
    }

    // Convert the read data to an integer value
    *value = strtol(retChars, NULL, 0);

    close(fd);
    return 0;
}
</code></pre>
 </details>
</li>
<li>
<p>We also made a prototype to do the voltage conversion for adc, make the <code>int adc_to_voltage(unsigned adcValue, float *voltage){}</code>:</p>
<ul>
<li>
<p>Try make this yourself first, implement this equation and make reference to the macros, <code>REFVOLTAGE</code> and <code>MAXADC</code>:</p>
<p>\[ V_{in} = \frac{adcValue\ \cdot\ V_{ref}}{2^n - 1} \]</p>
<ul>
<li>
<blockquote>
<p><strong>Note:</strong></p>
<blockquote>
<ul>
<li>Remember that you are peforming mathematical operations on whole numbers and decimals numbers, you may need to <code>cast</code>.</li>
</ul>
</blockquote>
</blockquote>
  <details>
  <summary>Code here...</summary>
<pre><code class="language-c">int adc_to_voltage(unsigned adcValue, float *voltage){

    *voltage = ( ( (float)adcValue * REFVOLTAGE ) / (float)MAXADC );

return 0;
}
</code></pre>
  </details>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Remember to use make to update the libraries:</p>
<p><img src="./figures/make_adc.gif" alt="" /></p>
</li>
</ol>
<h2 id="4-make-a-programme-to-utilise-the-continous-capibilities"><a class="header" href="#4-make-a-programme-to-utilise-the-continous-capibilities">4. Make a programme to utilise the continous capibilities</a></h2>
<ol>
<li>
<p>Create a directory whether you are storing your implementations, for me I use <code>~/examples_C/adc_continous_read</code></p>
</li>
<li>
<p>Once in the directory you can create a file called <code>adc_continous_read.c</code></p>
</li>
<li>
<p>We are going to modify the file to take user input, the pin number and the size of the buffer:</p>
 <details>
 <summary>Code here...</summary>
<pre><code class="language-c">#include "adc.h"
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

int main(int argc, char *argv[]) {
    if (argc != 3) {
        fprintf(stderr, "Usage: %s &lt;adcPin&gt; &lt;bufferLength&gt;\n", argv[0]);
        return EXIT_FAILURE;
    }

    unsigned int adcPin = atoi(argv[1]);
    unsigned int bufferLength = atoi(argv[2]);
    unsigned int adcValue;
    float voltage;

    // Enable buffer and set buffer length
    if (enable_buffer() &lt; 0) {
        fprintf(stderr, "Error enabling buffer.\n");
        return EXIT_FAILURE;
    }

    if (set_buffer_length(bufferLength) &lt; 0) {
        fprintf(stderr, "Error setting buffer length.\n");
        disable_buffer();
        return EXIT_FAILURE;
    }

    // Enable ADC channel
    if (enable_channel(adcPin) &lt; 0) {
        fprintf(stderr, "Error enabling ADC channel %u.\n", adcPin);
        disable_buffer();
        return EXIT_FAILURE;
    }

    printf("Starting continuous ADC read on pin %u...\n", adcPin);

    // Continuous read loop
    for (int i = 0; i &lt; bufferLength; i++) {
        if (adc_get_buffer(adcPin, &amp;adcValue) == 0) {
            adc_to_voltage(adcValue, &amp;voltage);
            printf("ADC Value: %u, Voltage: %.3f V\n", adcValue, voltage);
        } else {
            fprintf(stderr, "Error reading buffer for ADC pin %u.\n", adcPin);
            break;
        }

        //usleep(500000); // Delay between reads (adjust as needed, e.g., 500 ms)
    }

    // Cleanup: disable buffer and channel
    disable_channel(adcPin);
    disable_buffer();

    printf("Continuous ADC read completed.\n");

    return EXIT_SUCCESS;
}
</code></pre>
 </details>
 <p></p>
<ul>
<li><strong>Explanation of code base:</strong>
<ul>
<li>
<p>Main Function
The <code>main</code> function begins by checking the arguments. It requires two command-line arguments:</p>
<ol>
<li>
<p><code>adcPin</code>: The ADC pin number.</p>
</li>
<li>
<p><code>bufferLength</code>: Number of samples to read in continuous mode.</p>
<pre><code class="language-c">int main(int argc, char *argv[]) {
    if (argc != 3) {
        fprintf(stderr, "Usage: %s &lt;adcPin&gt; &lt;bufferLength&gt;\n", argv[0]);
        return EXIT_FAILURE;
    }
</code></pre>
</li>
<li>
<p>If the correct arguments aren't provided, it outputs an error and exits.</p>
</li>
</ol>
</li>
<li>
<p>Setting Up the ADC</p>
<ol>
<li>
<p>The program enables the buffer with <code>enable_buffer()</code> and sets the buffer length with <code>set_buffer_length(bufferLength)</code>. It then enables the specified ADC channel using <code>enable_channel(adcPin)</code>.</p>
<pre><code class="language-c">if (enable_buffer() &lt; 0) {
    fprintf(stderr, "Error enabling buffer.\n");
    return EXIT_FAILURE;
}

if (set_buffer_length(bufferLength) &lt; 0) {
    fprintf(stderr, "Error setting buffer length.\n");
    disable_buffer();
    return EXIT_FAILURE;
}

if (enable_channel(adcPin) &lt; 0) {
    fprintf(stderr, "Error enabling ADC channel %u.\n", adcPin);
    disable_buffer();
    return EXIT_FAILURE;
}
</code></pre>
</li>
</ol>
</li>
<li>
<p>Continuous Read Loop</p>
<ol>
<li>
<p>The program enters a loop that iterates <code>bufferLength</code> times, reading ADC values using <code>adc_get_buffer(adcPin, &amp;adcValue)</code> and converting each to voltage with <code>adc_to_voltage(adcValue, &amp;voltage)</code>. Each value is printed with both its ADC and voltage readings.</p>
<pre><code class="language-c">for (int i = 0; i &lt; bufferLength; i++) {
    if (adc_get_buffer(adcPin, &amp;adcValue) == 0) {
        adc_to_voltage(adcValue, &amp;voltage);
        printf("ADC Value: %u, Voltage: %.3f V\n", adcValue, voltage);
    } else {
        fprintf(stderr, "Error reading buffer for ADC pin %u.\n", adcPin);
        break;
    }
}
</code></pre>
<blockquote>
<p><strong>Note:</strong></p>
<blockquote>
<p>The <code>usleep</code> function is commented out here. In real applications, uncomment and adjust it to control the sample rate, if necessary.</p>
</blockquote>
</blockquote>
</li>
</ol>
</li>
<li>
<p>Cleanup and Exit</p>
<ol>
<li>After reading, the program disables the ADC channel and buffer, and then exits.
<pre><code class="language-c">disable_channel(adcPin);
disable_buffer();
printf("Continuous ADC read completed.\n");
return EXIT_SUCCESS;
</code></pre>
</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Create a <code>Makefile</code> and replicate the code below:</p>
 <details>
 <summary>Code here...</summary>
<pre><code class="language-Makefile"># Compiler and flags
CC = gcc
CFLAGS = -Wall -Werror

# Target executable name
TARGET = adc_continuous_read

# Source files
SRC = adc_continuous_read.c

# Library to link against
LIBS = -ladc

# Default target: build the executable
all: $(TARGET)

# Build the executable
$(TARGET): $(SRC)
    $(CC) $(CFLAGS) $(SRC) $(LIBS) -o $(TARGET)

# Clean up build artifacts
clean:
    rm -f $(TARGET)

# Phony targets to avoid conflicts with files of the same name
.PHONY: all clean

</code></pre>
 </details>
<ul>
<li>
<p>Now use <code>make</code> and compile the code and run:</p>
<p><img src="./figures/adc_continous_read.gif" alt="" /></p>
</li>
</ul>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ADCLibrary/ADCLibrary.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../PWMLibrary/PWMLibrary.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ADCLibrary/ADCLibrary.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../PWMLibrary/PWMLibrary.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
